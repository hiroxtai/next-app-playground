name: Auto-Approve PR

# 一人での開発環境向け: CI が成功したら PR を自動承認
# Dependabot PR 以外の通常の PR を対象とする
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

# PR を承認するために必要な権限
# GitHub リポジトリ設定で "Allow GitHub Actions to create and approve pull requests" を
# 有効にする必要があります
permissions:
  pull-requests: write
  contents: read

jobs:
  auto-approve:
    name: Auto-Approve PR after CI Success
    runs-on: ubuntu-latest
    # CI ワークフローが成功した場合のみ実行
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'pull_request'
    # タイムアウト設定: 5分以上かかる場合は強制終了
    timeout-minutes: 5

    steps:
      # PR 情報を取得
      # workflow_run イベントでは PR 情報が直接取得できないため、
      # workflow_run の artifacts から PR 番号を取得する
      - name: Get PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pulls = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`
            });
            
            if (pulls.data.length === 0) {
              console.log('No open PR found for this branch');
              return null;
            }
            
            const pr = pulls.data[0];
            
            // Dependabot PR は除外
            if (pr.user.login === 'dependabot[bot]') {
              console.log('Skipping Dependabot PR');
              return null;
            }
            
            console.log(`Found PR #${pr.number}`);
            return pr.number;

      # PR を自動承認
      # GitHub CLI (gh) を使用して承認を実行
      - name: Approve PR
        if: steps.pr.outputs.result != 'null'
        run: |
          gh pr review "$PR_NUMBER" --approve --body "✅ すべての CI チェックが成功しました。自動承認します。"
          echo "✅ PR #${PR_NUMBER} を自動承認しました"
        env:
          PR_NUMBER: ${{ steps.pr.outputs.result }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
